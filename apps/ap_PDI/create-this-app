#!/bin/bash
###############################################################################
# This script creates the application in the current directory.
# It invokes create-this-bsp. 
###############################################################################

###############################################################################
# USER SETTINGS: Select here the debug level and general CN API settings  	  #

DBG_MODE=_DEBUG	# compile printfs()
# DBG_MODE=NDEBUG # This define overwrites all others printf-debug defines
				# -> no printfs() will be compiled!

				
CN_API_FLAGS= 	# empty							
#CN_API_FLAGS="CN_API_USING_SPI"
                                                                              #
###############################################################################

###############################################################################
# include project configuration

. ../../project.config
BSP_DIR=./bsp
LIBAPIDIR=../../libCnApi

###############################################################################
INPUT_VARS=$@

echo --- This is create-this-app ---
echo input parameters: $INPUT_VARS

# First, check to see if $SOPC_KIT_NIOS2 environmental variable is set.
# This variable is required for the command line tools to execute correctly.
if [ -z $SOPC_KIT_NIOS2 ]
then
    echo Required \$SOPC_KIT_NIOS2 Environmental Variable is not set!
    exit 1
fi

# save arguments for passing to create-this-bsp
SAVE_ARGS=$@

# process arguments
SKIP_MAKE=
REBUILD=
NO_OPT=
while [ $# -gt 0 ]
do
  case "$1" in
      # Don't run make if create-this-app script is called with --no-make arg
      --no-make)
          SKIP_MAKE=1
          ;;
      --rebuild)
          rm -f ./Makefile
          REBUILD=1
          ;;
      --debug)
          NO_OPT=1
          ;;
	  --sopcdir)
		 shift
		 #relative path!
		 SOPC_DIR=$1
		 echo SOPC_DIR set to \"$SOPC_DIR\"
		 echo -------------------------------
		 ;;		  
  esac
  shift
done

###############################################################################
# Include directories
INCLUDES="\
${LIBAPIDIR}/include \
${LIBAPIDIR}/include/openPOWERLINK \
${LIBAPIDIR}/utils"

###############################################################################
# Custom libraries
LIBDIRS="${LIBAPIDIR}/target/nios2_newlib"
LIBNAMES="CnApi"
LIBTARGETFOLDER=$LIBAPIDIR/target/nios2_newlib

###############################################################################
# handle --debug parameter
# for explanation:
# 0x00000100L DEBUG_LVL_09 (= DEBUG_LVL_CNAPI_FUNC)
# 0x00000200L DEBUG_LVL_10 (= DEBUG_LVL_CNAPI_ERR)
# 0x00000400L DEBUG_LVL_11 (= DEBUG_LVL_CNAPI_INFO)
# 0x00000800L DEBUG_LVL_12 (= DEBUG_LVL_CNAPI_SPI)
# 0x00001000L DEBUG_LVL_13 (= DEBUG_LVL_CNAPI_ASYNC_INFO)
# 0x20000000L DEBUG_LVL_ASSERT                
# 0x80000000L DEBUG_LVL_ERROR
# 0x40000000L DEBUG_LVL_ALWAYS

if [ -z "$NO_OPT" ]; then
	DEF_DEBUG_LVL="0xE0000000L" # only ASSERT, ERROR and ALWAYS messages
else
	DEF_DEBUG_LVL="0xEC000F00L" # only ASSERT, ERROR and ALWAYS + CN API messages
fi

CFLAGS="-D${DBG_MODE} -DCN_API_FLAGS=${CN_API_FLAGS} -DDEF_DEBUG_LVL=${DEF_DEBUG_LVL}" # only PCP API debug

###############################################################################
# source files
SRCFILES="main.c"

###############################################################################
# work-around for bug in Nios2 EDS V9.0
cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --version"
$cmd | grep "9.0"
if [ "$?" == "0" ] ; then
# V9.0 needs additional double quotes around the include directories
INCLUDES=\"${INCLUDES}\"
fi

NIOS2_APP_GEN_ARGS="--elf-name epl.elf --set OBJDUMP_INCLUDE_SOURCE 1 \
--set CREATE_OBJDUMP 0 \
--set CFLAGS=\"${CFLAGS}\" \
--set APP_LIBRARY_DIRS=\"${LIBDIRS}\" \
--set APP_LIBRARY_NAMES=\"${LIBNAMES}\" \
--set APP_INCLUDE_DIRS=\"${INCLUDES}\" \
--src-files $SRCFILES"

if [ -z "$SOPC_DIR" ]; then
echo "No SOPC directory specified !"
echo "Use parameter: --sopcdir <SOPC_directory>"
exit 1
fi

if [ -z "$NO_OPT" ]; then
    NIOS2_APP_GEN_ARGS="${NIOS2_APP_GEN_ARGS} --set APP_CFLAGS_OPTIMIZATION -O2"
else
# in case of --debug option ("-g" means to insert debug information)
    NIOS2_APP_GEN_ARGS="${NIOS2_APP_GEN_ARGS} --set APP_CFLAGS_OPTIMIZATION -O1 --set APP_CFLAGS_DEBUG_LEVEL -g" 	
fi

# Also make sure that the APP has not been created already.  Check for
# existence of Makefile in the app directory
if [ -f ./Makefile ]
then
    echo Application has already been created!
    echo Delete Makefile if you want to create a new application makefile
    echo or call this script with parameter --rebuild
    exit 1
fi


# We are selecting hal_default bsp because it supports this application.
# Check to see if the hal_default has already been generated by checking for
# existence of the public.mk file.  If not, we need to run
# create-this-bsp file to generate the bsp.
if [ -n "$REBUILD" -o ! -f $BSP_DIR/public.mk ]; then
    # Since BSP doesn't exist, create the BSP
    # Pass any command line arguments passed to this script to the BSP.
    pushd $BSP_DIR >> /dev/null
    ./create-this-bsp $SAVE_ARGS --cpu-name ap_cpu  || {
    	echo "create-this-bsp failed"
    	exit 1
    }
    popd >> /dev/null
fi

cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --set QUARTUS_PROJECT_DIR=$SOPC_DIR $NIOS2_APP_GEN_ARGS"

echo "create-this-app: Running \"$cmd\""
$cmd || {
    echo "nios2-app-generate-makefile failed"
    exit 1
}

echo
echo "Rebuild target library before using it..."
echo 
make -C $LIBTARGETFOLDER clean
make -C $LIBTARGETFOLDER

if [ -f $LIBTARGETFOLDER/libCnApi.a ]
then
	echo
	echo "Target library rebuild done!"
	echo
else
    echo 
    echo "Target library rebuild ERROR!"
    echo "Rebuild stopped!"
	echo
    exit 1
fi

cat >> Makefile <<'Heredoc'

# Rules for EPCS flash programming commands (EPCS contains SOF and application)
PROGRAM_EPCS_SUFFIX := -epcs
PROGRAM_EPCS_TARGET := $(addsuffix $(PROGRAM_EPCS_SUFFIX), $(FLASH_FILES))

.PHONY : program-epcs
program-epcs : $(PROGRAM_EPCS_TARGET)

SOF_FILE := $(wildcard $(QUARTUS_PROJECT_DIR)/*.sof)

.PHONY : $(PROGRAM_EPCS_TARGET)
$(PROGRAM_EPCS_TARGET) : $(ELF)

	@$(ECHO) Info: Programming $(basename $@).flash	
	@if [ -n "$($(basename $@)_EPCS_FLAGS)" ]; \
	then \
		nios2-configure-sof $(DOWNLOAD_CABLE_FLAG) -C $(QUARTUS_PROJECT_DIR); \
		sof2flash --epcs --input=$(SOF_FILE) --output=sof.flash; \
		$(ELF2FLASH) --after=sof.flash --input=$(ELF) --outfile=$(basename $@)_after_sof.flash --sim_optimize=$(SIM_OPTIMIZE) $(elf2flash_extra_args); \
		$(ECHO) $(FLASHPROG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $@)_START) sof.flash $(basename $@)_after_sof.flash; \
		$(FLASHPROG) $(DOWNLOAD_CABLE_FLAG) $(SOPC_SYSID_FLAG) --epcs --base=$($(basename $@)_START) -g --override=../../powerlink/generic/nios2-flash-override.txt sof.flash $(basename $@)_after_sof.flash; \
	fi

Heredoc

if [ -z "$SKIP_MAKE" ]; then
	cmd="make"
	
	echo "make clean first..."
	make clean
	
	echo "create-this-app: Running \"$cmd\""
	$cmd || {
    	echo "make failed"
	    exit 1
	}

	echo
	echo "To download and run the application:"
	echo "    1. Make sure the board is connected to the system."
	echo "    2. Run 'nios2-configure-sof -C $SOPC_DIR' to configure the FPGA with the hardware design."
	echo "    3. If you have a stdio device, run 'nios2-terminal' in a different shell."
	echo "    4. Run 'make download-elf' from the application directory."
	echo
	echo "To debug the application:"
	echo "    Import the project into Nios II IDE.  Refer to Nios II IDE Documentation for more information."
	echo
	echo -e ""
fi


exit 0