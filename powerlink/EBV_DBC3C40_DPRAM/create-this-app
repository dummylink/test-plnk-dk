#!/bin/bash
###############################################################################
# This script creates the openPOWERLINK DPRAM Interface PCP application
# in this directory.
###############################################################################

###############################################################################
# include project configuration
#
. ../../project.config

if [ -z "$SOPC_DIR" ]; then
#SOPC_DIR=../../fpga/altera/EBV_DBC3C40/nios2_openmac_dpram_multinios
SOPC_DIR=../../fpga/altera/TERASIC_DE2-115/nios2_openmac_dpram_multinios
fi

BSP_DIR=./bsp
LIBAPIDIR=../../libCnApi
#
# replace this path to the object dictionary you wish to include
OBJDICTDIR=../../objDicts/digitalIO

###############################################################################
# Include directories
INCLUDES="\
. \
${POWERLINKDIR}/Edrv/openmac/include \
${POWERLINKDIR}/Include \
${POWERLINKDIR}/SharedBuff \
${POWERLINKDIR}/ObjDicts \
${POWERLINKDIR}/Target/altera_nios2/no_os/gnu/include \
${OBJDICTDIR} \
${LIBAPIDIR}/include \
${LIBAPIDIR}/utils"

#           Select here between debug and release settings
#DBG_MODE=NDEBUG
DBG_MODE=_DEBUG

#MODFLAGS=-D$(DBG_MODE)
#MODFLAGS=-D${DBG_MODE} -D_DBG_TRACE_POINTS_ -DDEF_DEBUG_LVL=0xEC000040L
#CFLAGS="-D${DBG_MODE} -D_DBG_TRACE_POINTS_ -DDEF_DEBUG_LVL=0xEC000000L"
CFLAGS="-D${DBG_MODE} -DDEF_DEBUG_LVL=0xEC00FF00L" # only PCP API debug

#EXTRA_CFLAGS = -Wa,-alhs $(INCLUDES) $(MODFLAGS)

SRCFILES="pcpMain.c \
pcpAsync.c \
pcpPdo.c \
pcpStateMachine.c \
${OBJDICTDIR}/Objdict.c \
${LIBAPIDIR}/utils/stateMachine.c \
${POWERLINKDIR}/Edrv/openmac/source/EdrvOpenMac.c \
${POWERLINKDIR}/Edrv/openmac/source/EplTimerSynck_OpenMac.c \
${POWERLINKDIR}/Edrv/openmac/source/EplTgtTimeStamp_OpenMac.c \
${POWERLINKDIR}/Edrv/openmac/source/omethlib.c ${POWERLINKDIR}/Edrv/openmac/source/omethlibint.c \
${POWERLINKDIR}/EplStack/EplDllk.c ${POWERLINKDIR}/EplStack/EplDllkCal.c \
${POWERLINKDIR}/EplStack/EplDlluCal.c \
${POWERLINKDIR}/EplStack/EplLedu.c \
${POWERLINKDIR}/EplStack/EplEventk.c ${POWERLINKDIR}/EplStack/EplEventu.c \
${POWERLINKDIR}/EplStack/EplNmtk.c \
${POWERLINKDIR}/EplStack/EplNmtu.c ${POWERLINKDIR}/EplStack/EplNmtCnu.c \
${POWERLINKDIR}/EplStack/EplPdok.c ${POWERLINKDIR}/EplStack/EplPdokCal.c \
${POWERLINKDIR}/EplStack/EplPdou.c ${POWERLINKDIR}/EplStack/EplPdouCal.c \
${POWERLINKDIR}/EplStack/EplObd.c \
${POWERLINKDIR}/EplStack/EplSdoComu.c ${POWERLINKDIR}/EplStack/EplSdoAsySequ.c ${POWERLINKDIR}/EplStack/EplSdoAsndu.c \
${POWERLINKDIR}/EplStack/EplTimeruGeneric.c \
${POWERLINKDIR}/EplStack/EplErrorHandlerk.c \
${POWERLINKDIR}/EplStack/EplApiGeneric.c \
${POWERLINKDIR}/EplStack/amiarm.c \
${POWERLINKDIR}/Target/altera_nios2/no_os/gnu/generic/ShbTarget_Nios2.c \
${POWERLINKDIR}/SharedBuff/SharedBuff.c ${POWERLINKDIR}/SharedBuff/ShbIpc-NoOS.c"

# work-around for bug in Nios2 EDS V9.0
cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --version"
$cmd | grep "9.0"
if [ "$?" == "0" ] ; then
# V9.0 needs additional double quotes around the include directories
INCLUDES=\"${INCLUDES}\"
fi

NIOS2_APP_GEN_ARGS="--elf-name epl.elf --set OBJDUMP_INCLUDE_SOURCE 1 \
--set CREATE_OBJDUMP 0 \
--set CFLAGS=\"${CFLAGS}\" --set APP_INCLUDE_DIRS=\"${INCLUDES}\" --src-files $SRCFILES"


#echo "${NIOS2_APP_GEN_ARGS}"

# First, check to see if $SOPC_KIT_NIOS2 environmental variable is set.
# This variable is required for the command line tools to execute correctly.
if [ -z $SOPC_KIT_NIOS2 ]
then
    echo Required \$SOPC_KIT_NIOS2 Environmental Variable is not set!
    exit 1
fi

# save arguments for passing to create-this-bsp
SAVE_ARGS=$@

# process arguments
SKIP_MAKE=
REBUILD=
NO_OPT=
while [ $# -gt 0 ]
do
  case "$1" in
      # Don't run make if create-this-app script is called with --no-make arg
      --no-make)
          SKIP_MAKE=1
          ;;
      --rebuild)
          rm -f ./Makefile
          REBUILD=1
          ;;
      --debug)
          NO_OPT=1
          ;;
  esac
  shift
done

if [ -z "$NO_OPT" ]; then
    NIOS2_APP_GEN_ARGS="${NIOS2_APP_GEN_ARGS} --set APP_CFLAGS_OPTIMIZATION -O2"
else
# in case of --debug option ("-g" means to insert debug information)
    NIOS2_APP_GEN_ARGS="${NIOS2_APP_GEN_ARGS} --set APP_CFLAGS_OPTIMIZATION -O1 --set APP_CFLAGS_DEBUG_LEVEL -g"
fi

# Also make sure that the APP has not been created already.  Check for
# existence of Makefile in the app directory
if [ -f ./Makefile ]
then
    echo Application has already been created!
    echo Delete Makefile if you want to create a new application makefile
    echo or call this script with parameter --rebuild
    exit 1
fi


# We are selecting hal_default bsp because it supports this application.
# Check to see if the hal_default has already been generated by checking for
# existence of the public.mk file.  If not, we need to run
# create-this-bsp file to generate the bsp.
if [ -n "$REBUILD" -o ! -f $BSP_DIR/public.mk ]; then
    # Since BSP doesn't exist, create the BSP
    # Pass any command line arguments passed to this script to the BSP.
    pushd $BSP_DIR >> /dev/null
    ./create-this-bsp --cpu-name pcp_cpu $SAVE_ARGS || {
    	echo "create-this-bsp failed"
    	exit 1
    }
    popd >> /dev/null
fi


cmd="nios2-app-generate-makefile --bsp-dir $BSP_DIR --set QUARTUS_PROJECT_DIR=$SOPC_DIR $NIOS2_APP_GEN_ARGS"

echo "create-this-app: Running \"$cmd\""
$cmd || {
    echo "nios2-app-generate-makefile failed"
    exit 1
}

if [ -z "$SKIP_MAKE" ]; then
	cmd="make"

	echo "create-this-app: Running \"$cmd\""
	$cmd || {
    	echo "make failed"
	    exit 1
	}

	echo
	echo "To download and run the application:"
	echo "    1. Make sure the board is connected to the system."
	echo "    2. Run 'nios2-configure-sof -C $SOPC_DIR' to configure the FPGA with the hardware design."
	echo "    3. If you have a stdio device, run 'nios2-terminal' in a different shell."
	echo "    4. Run 'make download-elf' from the application directory."
	echo
	echo "To debug the application:"
	echo "    Import the project into Nios II IDE.  Refer to Nios II IDE Documentation for more information."
	echo
	echo -e ""
fi


exit 0
